"use strict";(()=>{var e={};e.id=982,e.ids=[982],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},972:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>R,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>f,staticGenerationAsyncStorage:()=>T});var n={};r.r(n),r.d(n,{GET:()=>S,dynamic:()=>l,runtime:()=>u});var a=r(9303),i=r(8716),o=r(670),s=r(4332);let u="nodejs",l="force-dynamic",c=Number(process.env.BITRIX_TZ_OFFSET_MINUTES??0);function p(e=1,t=new Date){let r=new Date(t);return r.setSeconds(0,0),r.setMinutes(r.getMinutes()+e),r.getTime()}async function d(e,t){let r=process.env.BITRIX_WEBHOOK_BASE.replace(/\/?$/,"/")+"tasks.task.add.json",n={TITLE:e.title||"",DESCRIPTION:e.description||"",RESPONSIBLE_ID:e.responsibleId?Number(e.responsibleId):void 0,AUDITORS:(e.observers||[]).map(e=>Number(e)).filter(e=>Number.isFinite(e)),PRIORITY:2===e.priority?2:1,TASK_CONTROL:e.requireResult?"Y":"N"},a=function(e,t){if(!e||null==t)return;let r=String(e).match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);if(!r)return;let n=+r[1],a=+r[2]-1,i=new Date(Date.UTC(n,a,+r[3],+r[4],+r[5])-6e4*t+6e4*c),o=e=>String(e).padStart(2,"0");return`${i.getUTCFullYear()}-${o(i.getUTCMonth()+1)}-${o(i.getUTCDate())}T${o(i.getUTCHours())}:${o(i.getUTCMinutes())}:00`}(e.deadline||void 0,t);a&&(n.DEADLINE=a);let i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fields:n})}),o=await i.json().catch(async()=>({raw:await i.text()}));if(!i.ok||o?.error)throw Error(`Bitrix error: ${o?.error||i.status}`)}async function S(){let e=Date.now(),t=await s.kv.zrangeByScore("jobs:next",0,e);if(!t||0===t.length)return Response.json({ok:!0,ran:0,at:new Date().toISOString()});let r=0;for(let e of t){let t=await s.kv.getJSON(`job:${e}`);if(!t){await s.kv.zrem("jobs:next",e);continue}try{if(await d(t.template,t.tzOffsetMinutes),r++,"number"==typeof t.remainingRuns&&(t.remainingRuns-=1,t.remainingRuns<=0)){await s.Z.multi().del(`job:${e}`).zrem("jobs:next",e).exec();continue}let n="daily"===t.kind?function(e,t,r=new Date){let n=new Date(r.getTime()+6e4*t),[a,i]=e.split(":").map(e=>parseInt(e,10)),o=new Date(n);return o.setHours(a,i,0,0),o<=n&&o.setDate(o.getDate()+1),o.getTime()-6e4*t}(t.timeOfDay||"05:00",t.tzOffsetMinutes,new Date):p(t.stepMinutes||1,new Date);await s.Z.multi().set(`job:${e}`,JSON.stringify(t)).zadd("jobs:next",{score:n,member:e}).exec()}catch(r){let t=p(1);await s.kv.zadd("jobs:next",t,e)}}return Response.json({ok:!0,ran:r,at:new Date().toISOString()})}let g=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/regular/cron/route",pathname:"/api/regular/cron",filename:"route",bundlePath:"app/api/regular/cron/route"},resolvedPagePath:"/Users/user/Desktop/b24-regular-task/app/api/regular/cron/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:m,staticGenerationAsyncStorage:T,serverHooks:f}=g,w="/api/regular/cron/route";function R(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:T})}},4332:(e,t,r)=>{r.d(t,{Z:()=>o,kv:()=>s});var n=r(6859);let a=null;function i(){if(a)return a;let e=process.env.UPSTASH_REDIS_REST_URL,t=process.env.UPSTASH_REDIS_REST_TOKEN;if(!e||!t)throw Error("UPSTASH_REDIS_REST_URL / UPSTASH_REDIS_REST_TOKEN are not set");return a=new n.s({url:e,token:t})}let o=new Proxy({},{get:(e,t)=>i()[t]}),s={async getJSON(e){let t=await i().get(e);return t?JSON.parse(t):null},setJSON:async(e,t)=>i().set(e,JSON.stringify(t)),zadd:(e,t,r)=>i().zadd(e,{score:t,member:r}),zrem:(e,t)=>i().zrem(e,t),zrangeByScore:async(e,t,r)=>await i().zrange(e,t,r,{byScore:!0})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[948,113],()=>r(972));module.exports=n})();