"use strict";(()=>{var e={};e.id=759,e.ids=[759],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4984:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>b,requestAsyncStorage:()=>T,routeModule:()=>y,serverHooks:()=>M,staticGenerationAsyncStorage:()=>R});var i={};r.r(i),r.d(i,{POST:()=>I,dynamic:()=>w,runtime:()=>S});var s=r(9303),n=r(8716),a=r(670);let o=require("node:fs/promises");var u=r.n(o);let l=require("node:path");var d=r.n(l);let c=d().join(process.cwd(),"data"),p=d().join(c,"schedules.json"),g=Number(process.env.BITRIX_TZ_OFFSET_MINUTES??0);function f(e,t,r=new Date){let i=new Date(r.getTime()+6e4*t),[s,n]=e.split(":").map(e=>parseInt(e,10)),a=new Date(i);return a.setHours(s,n,0,0),a<=i&&a.setDate(a.getDate()+1),new Date(a.getTime()-6e4*t)}function h(e=1,t=new Date){let r=new Date(t);return r.setSeconds(0,0),r.setMinutes(r.getMinutes()+e),r}function m(e,t,r){let[i,s,n]=e.split("-").map(e=>parseInt(e,10)),[a,o]=t.split(":").map(e=>parseInt(e,10));return new Date(new Date(Date.UTC(i,s-1,n,a,o,0,0)).getTime()-6e4*r)}class D{constructor(){this.jobs=new Map,this.timer=null,this.saving=!1,this.init().catch(e=>console.error("[scheduler] init error",e))}async init(){await u().mkdir(c,{recursive:!0}).catch(()=>{}),await this.load(),this.timer||(this.timer=setInterval(()=>this.tick().catch(e=>console.error("[scheduler] tick error",e)),1e4),setTimeout(()=>this.tick().catch(()=>{}),2e3)),console.log("[scheduler] started, jobs:",this.jobs.size)}async load(){try{let e=await u().readFile(p,"utf8");JSON.parse(e).forEach(e=>this.jobs.set(e.id,e))}catch{}}async save(){if(!this.saving){this.saving=!0;try{await u().writeFile(p,JSON.stringify([...this.jobs.values()],null,2),"utf8")}finally{this.saving=!1}}}list(){return[...this.jobs.values()]}async register(e){let t,r;let i=new Date,s="daily"===e.kind?f(e.timeOfDay||"05:00",e.tzOffsetMinutes,i):h(e.stepMinutes||1,i);if(e.startDateYYYYMMDD&&s<(t="daily"===e.kind?m(e.startDateYYYYMMDD,e.timeOfDay||"05:00",e.tzOffsetMinutes):m(e.startDateYYYYMMDD,"00:00",e.tzOffsetMinutes))&&(s=t),e.endDateYYYYMMDD){let[t,i,s]=e.endDateYYYYMMDD.split("-").map(e=>parseInt(e,10));r=new Date(new Date(Date.UTC(t,i-1,s,23,59,59,999)).getTime()-6e4*e.tzOffsetMinutes)}let n={id:e.id,kind:e.kind,timeOfDay:e.timeOfDay,stepMinutes:e.stepMinutes,tzOffsetMinutes:e.tzOffsetMinutes,nextRunISO:s.toISOString(),startAtISO:t?.toISOString(),endAtISO:r?.toISOString(),remainingRuns:e.remainingRuns,template:e.template};return this.jobs.set(n.id,n),await this.save(),n}async unregister(e){this.jobs.delete(e),await this.save()}async tick(){if(0===this.jobs.size)return;let e=new Date;for(let t of this.jobs.values()){if(t.endAtISO&&e>new Date(t.endAtISO)){await this.unregister(t.id);continue}if(!(e<new Date(t.nextRunISO)))try{if(await this.createBitrixTask(t),"number"==typeof t.remainingRuns&&(t.remainingRuns-=1,t.remainingRuns<=0)){await this.unregister(t.id);continue}let r="daily"===t.kind?f(t.timeOfDay||"05:00",t.tzOffsetMinutes,e):h(t.stepMinutes||1,e);t.startAtISO&&r<new Date(t.startAtISO)&&r.setTime(new Date(t.startAtISO).getTime()),t.nextRunISO=r.toISOString(),await this.save(),console.log("[scheduler] run job",t.id,"next:",t.nextRunISO)}catch(i){console.error("[scheduler] job error",t.id,i);let r="daily"===t.kind?f(t.timeOfDay||"05:00",t.tzOffsetMinutes,e):h(t.stepMinutes||1,e);t.nextRunISO=r.toISOString(),await this.save()}}}async createBitrixTask(e){let t=process.env.BITRIX_WEBHOOK_BASE;if(!t)throw Error("BITRIX_WEBHOOK_BASE not set");let r=t.replace(/\/?$/,"/")+"tasks.task.add.json",i=e.template,s={TITLE:i.title||"",DESCRIPTION:i.description||"",RESPONSIBLE_ID:i.responsibleId?Number(i.responsibleId):void 0,ACCOMPLICES:(i.coAssignees||[]).map(e=>Number(e)).filter(e=>Number.isFinite(e)),AUDITORS:(i.observers||[]).map(e=>Number(e)).filter(e=>Number.isFinite(e)),PRIORITY:2===i.priority?2:1,TASK_CONTROL:i.requireResult?"Y":"N"},n=function(e,t){if(!e||null==t)return;let r=String(e).match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/);if(!r)return;let[i,s,n,a,o,u]=r,l=new Date(Date.UTC(+s,+n-1,+a,+o,+u)-6e4*t+6e4*g),d=e=>String(e).padStart(2,"0");return`${l.getUTCFullYear()}-${d(l.getUTCMonth()+1)}-${d(l.getUTCDate())}T${d(l.getUTCHours())}:${d(l.getUTCMinutes())}:00`}(i.deadline||void 0,e.tzOffsetMinutes);n&&(s.DEADLINE=n);let a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fields:s})}),o=await a.json().catch(async()=>({raw:await a.text()}));if(!a.ok||o?.error)throw Error(`Bitrix error: ${o?.error||a.status}`);return o?.result}}let O=global.__REGULAR_SCHEDULER__??new D;global.__REGULAR_SCHEDULER__||(global.__REGULAR_SCHEDULER__=O);let S="nodejs",w="force-dynamic";async function I(e){try{let t=await e.json(),r=String(t?.id||"");if(!r)return new Response(JSON.stringify({ok:!1,error:"id required"}),{status:400});return await O.unregister(r),Response.json({ok:!0})}catch(e){return new Response(JSON.stringify({ok:!1,error:e?.message||"unregister failed"}),{status:500})}}let y=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/regular/unregister/route",pathname:"/api/regular/unregister",filename:"route",bundlePath:"app/api/regular/unregister/route"},resolvedPagePath:"/Users/user/Desktop/b24-regular-task/app/api/regular/unregister/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:T,staticGenerationAsyncStorage:R,serverHooks:M}=y,v="/api/regular/unregister/route";function b(){return(0,a.patchFetch)({serverHooks:M,staticGenerationAsyncStorage:R})}},9303:(e,t,r)=>{e.exports=r(517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[948],()=>r(4984));module.exports=i})();